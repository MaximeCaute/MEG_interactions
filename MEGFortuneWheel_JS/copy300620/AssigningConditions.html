<!doctype html>
<html>

<head>
	<script src="jquery-3.3.1.min.js"></script>
	<script src="jatos.js"></script>
	<link id="styleSheetGame" rel="stylesheet" href="CreditAssignment_styles.css" type="text/css">
</head>

<body>
	<p>Loading...</p>

</body>

<script>
	// I've adapted the code from the example study 'Randomize Task Between Workers'
var nextCondition
  jatos.onLoad(function () {
		// If run locally, skip the first component (needs to be set within JATOS..)
		if (jatos.componentJsonInput.settings=="Local"){
				jatos.startNextComponent()
		} else {
			initBatchConditions()
			continueJATOS() // when JATOS is ready, automatically continue with the next steps
		}
  });

	// We use JATOS' Batch Session to store which conditions are available.
	// If this is the first run we have to initialize the Batch Session with
	// the data from the component's JSON input. You can 'reset' the conditions
	// by deleting them from the Batch Session.

	// This means that to run this in the settings of the properties in JATOS I should write:
/*
	{
  "conditionCounts": {
    "A": 3,
    "B": 3,
    "C": 3,
		"D": 3,
		"E": 3,
		"F": 3
  }
}
*/
	function initBatchConditions() {
		// Check if 'conditions' are not already in the batch session
		if (!jatos.batchSession.defined("/conditions")) {
			// Get the count of each condition
			var conditionCounts = jatos.componentJsonInput.conditionCounts;
			var conditions = [];
			// Fill the array with conditions according to the counters
			fillArrayWithValues(conditions, "1", conditionCounts.A);
			fillArrayWithValues(conditions, "2", conditionCounts.B);
			fillArrayWithValues(conditions, "3", conditionCounts.C);
			fillArrayWithValues(conditions, "4", conditionCounts.D);
			fillArrayWithValues(conditions, "5", conditionCounts.E);
			// Put the conditions in the batch session
			jatos.batchSession.set("conditions", conditions)
				.fail(initBatchConditions); // If it fails: try again
		}

	}

	function fillArrayWithValues(array, value, count) {
		for (var i = 0; i < count; i++) {
			array.push(value);
		}
	}

	// when JATOS is ready, continue
	function continueJATOS(){
		nextCondition = getNextCondition();
	}

function storeCurrentCondition(){
	var studySessionData = { "thisCondition": nextCondition};
	var promise= jatos.setStudySessionData(studySessionData);
  console.log('trying to add this Condition')
	promise.done(function(){
		console.log('added thisCondition')
		//var resultData = nextCondition;
		console.log('study session data is:')
		console.log(jatos.studySessionData)
		jatos.startNextComponent() //resultData);
	})
	promise.fail(function(){
		console.log('failure')
		storeCurrentCondition()
	})
}

	function getNextCondition() {
		// Get the still available conditions from the Batch Session
		var conditions
    loadConditionFromJATOS()
		function loadConditionFromJATOS(){
			var temp = jatos.batchSession.get("conditions");
			if ((typeof temp=='undefined') || temp.length==0){
				console.log('failed to load conditions from JATOS')
				loadConditionFromJATOS()
			} else{
				conditions=temp
				console.log('managed to load conditions from JATOS')
			}
		}

		// If no more conditions throw an error
		if (conditions.length == 0) {
			$('p').text("Error: max number of workers reached.");
			throw "Max number of workers reached.";
		}
		// Get a random condition
		var randomIndex = Math.floor(Math.random() * conditions.length);
		var randomCondition = conditions[randomIndex];
		// Delete the choosen condition from the array
		conditions.splice(randomIndex, 1);
		// Set the changed conditions array in the Batch Session.

		var promise= jatos.batchSession.set("conditions", conditions)
		promise.done(function(){
			console.log('updated')
			nextCondition=randomCondition;
			storeCurrentCondition()
		})
		promise.fail(function(){
			console.log('failure')
			randomCondition = getNextCondition();
		})
	}



</script>
